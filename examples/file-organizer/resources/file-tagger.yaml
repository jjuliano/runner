resources:
  - id: jdberry-tag
    name: "Clone and build jdberry/tag"
    desc: "jdberry/tag will be used to tag the files"
    category: "tagger"
    requires:
      - git
      - xcode-select
    run:
      - name: "clone github.com/jdberry/tag"
        exec: "git clone https://github.com/jdberry/tag.git"
        skip:
          - "DIR:tag"
        expect:
          - "DIR:tag"
      - name: "build"
        exec: "pushd tag && make && popd"
        check:
          - "CMD:make"
        skip:
          - "FILE:tag/bin/tag"

  - id: ai-tag
    name: "tag the file using LLM"
    desc: "automatically tag the file using AI"
    category: "tagger"
    requires:
      - jdberry-tag
    run:
      - name: "ask LLM about the file"
        check:
          - "FILE:tag/bin/tag"
          - "ENV:KDEPS_PARAMS1"
        env:
          - name: "FILE_CONTENTS"
            file: "$KDEPS_PARAMS1"
            prompt_safe: true
          - name: "FILE_TYPE"
            exec: "file $KDEPS_PARAMS1"
        llm: "llama3.1"
        chat: |
          Quick answer: In 1 sentence, please provide a summary of this content -- \"$FILE_CONTENTS\"
      - name: "chat prompt to tag the file"
        check:
          - "FILE:tag/bin/tag"
          - "ENV:KDEPS_PARAMS1"
          - "ENV:KDEPS_LLM_OUTPUT"
        env:
          - name: "FILE_SUMMARY"
            exec: "echo $KDEPS_LLM_OUTPUT"
          - name: "FILE_TYPE"
            exec: "file $KDEPS_PARAMS1"
        llm: "llama3.1"
        chat: |
          Quick answer: Given the file \"$FILE_TYPE\", with summary of its content -- \$FILE_SUMMARY\", generate 3 suitable comma-separated file tag for it. Ensure that the tags are based on the file contents.
      - name: "show and store the tag"
        env:
          - name: "FILE_TAG"
            exec: "echo $KDEPS_LLM_OUTPUT"
        exec: "echo $KDEPS_LLM_OUTPUT"
      - name: "tag a given file"
        check:
          - "FILE:tag/bin/tag"
          - "ENV:KDEPS_PARAMS1"
          - "ENV:KDEPS_LLM_OUTPUT"
        exec: "tag/bin/tag -a \"$KDEPS_LLM_OUTPUT\" $KDEPS_PARAMS1"
